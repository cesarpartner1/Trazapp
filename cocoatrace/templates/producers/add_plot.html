{% extends 'dashboard/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="page-heading">
        <div>
            <p class="page-subtitle">{{ producer.code }}</p>
            <h1 class="page-title">Add New Plot</h1>
            <p class="page-helper">Draw the farm boundary and capture key agronomic details.</p>
        </div>
        <a href="{% url 'producer_detail' producer.pk %}" class="btn btn-outline-secondary">Back to Profile</a>
    </div>

    {% if form.errors %}
    <div class="alert alert-danger" role="alert">
        <strong>Validation errors:</strong>
        <ul class="mb-0">
            {% for field in form %}
                {% for error in field.errors %}
                <li>{{ error }}</li>
                {% endfor %}
            {% endfor %}
            {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <div class="card-flow">
        <div class="card">
            <div class="card-header d-flex align-items-center justify-content-between">
                <div>
                    <span class="step-indicator">1</span>
                    Locate & Draw Plot
                </div>
                <div class="d-flex gap-2">
                    <label class="btn btn-outline-secondary mb-0" for="geojson-upload">
                        <i class="fa-solid fa-file-import me-2"></i>Upload GeoJSON
                    </label>
                    <input type="file" id="geojson-upload" accept="application/geo+json,application/json" hidden>
                </div>
            </div>
            <div class="card-body">
                <div id="map" class="plot-map"></div>
                <p class="small text-secondary mt-2">Draw a single polygon that represents the plot boundary or upload a GeoJSON file. Only one shape can be stored per plot.</p>
                <div class="d-flex justify-content-end mt-3">
                    <button class="btn btn-primary" type="button" id="go-to-details">Next: Plot Details</button>
                </div>
            </div>
        </div>

        <form method="post" class="card" id="plot-details" data-step="details">
            {% csrf_token %}
            {{ form.polygon }}
            <div class="card-header d-flex align-items-center justify-content-between">
                <div>
                    <span class="step-indicator">2</span>
                    Plot Details
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label" for="id_name">Plot Name</label>
                        {{ form.name }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="id_plot_code">Plot Identifier</label>
                        {{ form.plot_code }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="id_area_hectares">Area (hectares)</label>
                        {{ form.area_hectares }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Captured Geometry</label>
                        <div class="geometry-chip" id="geometry-status">No polygon captured yet</div>
                    </div>
                </div>
            </div>
            <div class="card-footer d-flex justify-content-between">
                <button class="btn btn-outline-secondary" type="button" id="back-to-map">Back</button>
                <button type="submit" class="btn btn-primary">Save Plot</button>
            </div>
        </form>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const mapElement = document.getElementById('map');
    if (!mapElement) {
        return;
    }

    if (typeof L === 'undefined') {
        console.error('Leaflet failed to load. Check your internet connection.');
        return;
    }

    const theme = document.documentElement.getAttribute('data-theme') || 'light';
    const map = L.map(mapElement).setView([6.2518, -75.5636], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    if (!L.Control.Draw) {
        console.error('Leaflet Draw plugin failed to load. Drawing tools will be unavailable.');
    } else {
        const drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems
            },
            draw: {
                polygon: {
                    shapeOptions: {
                        color: theme === 'dark' ? '#38bdf8' : '#2563eb',
                        weight: 2
                    }
                },
                polyline: false,
                rectangle: false,
                circle: false,
                marker: false,
                circlemarker: false
            }
        });
        map.addControl(drawControl);
    }

    const geometryField = document.getElementById('{{ form.polygon.auto_id }}');
    const geometryChip = document.getElementById('geometry-status');
    const detailsCard = document.getElementById('plot-details');
    const nextBtn = document.getElementById('go-to-details');
    const backBtn = document.getElementById('back-to-map');
    const geojsonUpload = document.getElementById('geojson-upload');

    if (!geometryField || !geometryChip || !detailsCard || !nextBtn || !backBtn || !geojsonUpload) {
        console.error('Plot form elements are missing.');
        return;
    }

    function updateGeometryDisplay(geometry) {
        if (geometry) {
            const vertexCount = geometry.coordinates?.[0]?.length || 0;
            geometryChip.textContent = `${geometry.type} â€¢ ${vertexCount} vertices`;
            geometryChip.classList.add('has-geometry');
        } else {
            geometryChip.textContent = 'No polygon captured yet';
            geometryChip.classList.remove('has-geometry');
        }
    }

    function setGeometry(geometry) {
        geometryField.value = geometry ? JSON.stringify(geometry) : '';
        updateGeometryDisplay(geometry);
    }

    function showDetailsStep() {
        detailsCard.classList.add('active');
        detailsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function returnToMap() {
        detailsCard.classList.remove('active');
        document.querySelector('.card-flow').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    if (L.Control.Draw) {
        map.on(L.Draw.Event.CREATED, function (event) {
            const layer = event.layer;
            drawnItems.clearLayers();
            drawnItems.addLayer(layer);
            const geojson = layer.toGeoJSON();
            setGeometry(geojson.geometry);
        });

        map.on(L.Draw.Event.DELETED, function () {
            setGeometry(null);
        });
    }

    nextBtn.addEventListener('click', function () {
        if (!geometryField.value) {
            alert('Capture the plot geometry before moving on.');
            return;
        }
        showDetailsStep();
    });

    backBtn.addEventListener('click', function () {
        returnToMap();
    });

    geojsonUpload.addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = function (uploadEvent) {
            try {
                const data = JSON.parse(uploadEvent.target.result);
                const geometry = data.type === 'Feature' ? data.geometry : data;

                if (!geometry || (geometry.type !== 'Polygon' && geometry.type !== 'MultiPolygon')) {
                    alert('Only Polygon or MultiPolygon GeoJSON is supported.');
                    return;
                }

                drawnItems.clearLayers();
                const layer = L.geoJSON(geometry);
                layer.eachLayer(function (l) {
                    drawnItems.addLayer(l);
                });
                if (drawnItems.getLayers().length) {
                    map.fitBounds(drawnItems.getBounds(), { padding: [20, 20] });
                }
                setGeometry(geometry);
                showDetailsStep();
            } catch (error) {
                console.error(error);
                alert('Unable to parse the GeoJSON file.');
            }
        };

        reader.readAsText(file);
    });

    setTimeout(() => map.invalidateSize(), 250);

    if (geometryField.value) {
        try {
            const geometry = JSON.parse(geometryField.value);
            const layer = L.geoJSON(geometry);
            layer.eachLayer(function (l) {
                drawnItems.addLayer(l);
            });
            if (drawnItems.getLayers().length) {
                map.fitBounds(drawnItems.getBounds(), { padding: [20, 20] });
            }
            updateGeometryDisplay(geometry);
            showDetailsStep();
        } catch (error) {
            console.warn('Saved geometry could not be rendered', error);
        }
    }

    {% if form.errors %}
    showDetailsStep();
    {% endif %}
});
</script>
{% endblock %}
