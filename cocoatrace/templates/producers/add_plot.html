{% extends 'dashboard/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="page-heading">
        <div>
            <p class="page-subtitle">{{ producer.code }}</p>
            <h1 class="page-title">{{ page_title|default:"Nueva parcela" }}</h1>
            <p class="page-helper">{{ page_helper|default:"Dibuja el límite de la finca y captura los datos agronómicos clave." }}</p>
        </div>
        <a href="{{ cancel_url|default:'#' }}" class="btn btn-outline-secondary">Volver al perfil</a>
    </div>

    {% if form.errors %}
    <div class="alert alert-danger" role="alert">
        <strong>Errores de validación:</strong>
        <ul class="mb-0">
            {% for field in form %}
                {% for error in field.errors %}
                <li>{{ error }}</li>
                {% endfor %}
            {% endfor %}
            {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <div class="card-flow">
        <div class="card">
            <div class="card-header d-flex align-items-center justify-content-between">
                <div>
                    <span class="step-indicator">1</span>
                    Ubica y dibuja la parcela
                </div>
                <div class="d-flex gap-2">
                    <label class="btn btn-outline-secondary mb-0" for="geojson-upload">
                        <i class="fa-solid fa-file-import me-2"></i>Importar GeoJSON
                    </label>
                    <input type="file" id="geojson-upload" accept="application/geo+json,application/json" hidden>
                </div>
            </div>
            <div class="card-body">
                <div id="map" class="plot-map"></div>
                <p class="small text-secondary mt-2">Dibuja un único polígono que represente el límite de la parcela o sube un archivo GeoJSON. Solo se almacena una geometría por parcela.</p>
                <div class="d-flex justify-content-end mt-3">
                    <button class="btn btn-primary" type="button" id="go-to-details">Siguiente: detalles de la parcela</button>
                </div>
            </div>
        </div>

        <form method="post" class="card" id="plot-details" data-step="details">
            {% csrf_token %}
            {{ form.polygon }}
            <div class="card-header d-flex align-items-center justify-content-between">
                <div>
                    <span class="step-indicator">2</span>
                    Detalles de la parcela
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label" for="id_name">Nombre de la parcela</label>
                        {{ form.name }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="id_plot_code">Identificador de parcela</label>
                        {{ form.plot_code }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="id_area_hectares">Área (hectáreas)</label>
                        {{ form.area_hectares }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Geometría capturada</label>
                        <div class="geometry-chip" id="geometry-status">Sin geometría capturada</div>
                    </div>
                </div>
            </div>
            <div class="card-footer d-flex justify-content-between">
                <button class="btn btn-outline-secondary" type="button" id="back-to-map">Regresar</button>
                <button type="submit" class="btn btn-primary">{{ submit_label|default:"Guardar parcela" }}</button>
            </div>
        </form>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const mapElement = document.getElementById('map');
    if (!mapElement) {
        return;
    }

    if (typeof L === 'undefined') {
        console.error('Leaflet no se pudo cargar. Verifica tu conexión a internet.');
        return;
    }

    const theme = document.documentElement.getAttribute('data-theme') || 'light';
    const map = L.map(mapElement).setView([6.2518, -75.5636], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    if (!L.Control.Draw) {
        console.error('Leaflet Draw no se pudo cargar. Las herramientas de dibujo no estarán disponibles.');
    } else {
        const drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems
            },
            draw: {
                polygon: {
                    shapeOptions: {
                        color: theme === 'dark' ? '#38bdf8' : '#2563eb',
                        weight: 2
                    }
                },
                polyline: false,
                rectangle: false,
                circle: false,
                marker: false,
                circlemarker: false
            }
        });
        map.addControl(drawControl);
    }

    const geometryField = document.getElementById('{{ form.polygon.auto_id }}');
    const geometryChip = document.getElementById('geometry-status');
    const detailsCard = document.getElementById('plot-details');
    const nextBtn = document.getElementById('go-to-details');
    const backBtn = document.getElementById('back-to-map');
    const geojsonUpload = document.getElementById('geojson-upload');

    if (!geometryField || !geometryChip || !detailsCard || !nextBtn || !backBtn || !geojsonUpload) {
        console.error('Faltan elementos del formulario de parcela.');
        return;
    }

    function countVertices(geometry) {
        if (!geometry || !geometry.coordinates) {
            return 0;
        }
        if (geometry.type === 'Polygon') {
            return geometry.coordinates.reduce((total, ring) => total + (ring?.length || 0), 0);
        }
        if (geometry.type === 'MultiPolygon') {
            return geometry.coordinates.reduce((total, polygon) => {
                return total + polygon.reduce((polyTotal, ring) => polyTotal + (ring?.length || 0), 0);
            }, 0);
        }
        return 0;
    }

    function updateGeometryDisplay(geometry) {
        if (geometry) {
            const vertexCount = countVertices(geometry);
            geometryChip.textContent = `${geometry.type} • ${vertexCount} vértices`;
            geometryChip.classList.add('has-geometry');
        } else {
            geometryChip.textContent = 'Sin geometría capturada';
            geometryChip.classList.remove('has-geometry');
        }
    }

    function setGeometry(geometry) {
        geometryField.value = geometry ? JSON.stringify(geometry) : '';
        updateGeometryDisplay(geometry);
    }

    function showDetailsStep() {
        detailsCard.classList.add('active');
        detailsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function returnToMap() {
        detailsCard.classList.remove('active');
        document.querySelector('.card-flow').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    if (L.Control.Draw) {
        map.on(L.Draw.Event.CREATED, function (event) {
            const layer = event.layer;
            drawnItems.clearLayers();
            drawnItems.addLayer(layer);
            const geojson = layer.toGeoJSON();
            setGeometry(geojson.geometry);
        });

        map.on(L.Draw.Event.DELETED, function () {
            setGeometry(null);
        });

        map.on(L.Draw.Event.EDITED, function (event) {
            let updatedGeometry = null;
            event.layers.eachLayer(function (layer) {
                // Tomamos la primera geometría editada porque solo se permite un polígono activo.
                if (!updatedGeometry) {
                    updatedGeometry = layer.toGeoJSON().geometry;
                }
            });
            if (updatedGeometry) {
                setGeometry(updatedGeometry);
            } else {
                setGeometry(null);
            }
        });
    }

    nextBtn.addEventListener('click', function () {
        if (!geometryField.value) {
            alert('Captura la geometría de la parcela antes de continuar.');
            return;
        }
        showDetailsStep();
    });

    backBtn.addEventListener('click', function () {
        returnToMap();
    });

    geojsonUpload.addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = function (uploadEvent) {
            try {
                const data = JSON.parse(uploadEvent.target.result);
                let geometry = null;

                if (data.type === 'FeatureCollection' && Array.isArray(data.features)) {
                    const merged = [];
                    data.features.forEach(feature => {
                        const geom = feature?.geometry;
                        if (!geom) {
                            return;
                        }
                        if (geom.type === 'Polygon' && Array.isArray(geom.coordinates)) {
                            merged.push(geom.coordinates);
                        } else if (geom.type === 'MultiPolygon' && Array.isArray(geom.coordinates)) {
                            geom.coordinates.forEach(coords => merged.push(coords));
                        }
                    });

                    if (!merged.length) {
                        alert('La colección no contiene polígonos válidos. Asegúrate de incluir geometrías Polygon o MultiPolygon.');
                        return;
                    }

                    geometry = merged.length === 1
                        ? { type: 'Polygon', coordinates: merged[0] }
                        : { type: 'MultiPolygon', coordinates: merged };
                } else if (data.type === 'Feature') {
                    geometry = data.geometry;
                } else {
                    geometry = data;
                }

                if (!geometry || (geometry.type !== 'Polygon' && geometry.type !== 'MultiPolygon')) {
                    alert('Solo se admite GeoJSON de tipo Polygon o MultiPolygon.');
                    return;
                }

                drawnItems.clearLayers();
                const layer = L.geoJSON(geometry);
                layer.eachLayer(function (l) {
                    drawnItems.addLayer(l);
                });
                if (drawnItems.getLayers().length) {
                    map.fitBounds(drawnItems.getBounds(), { padding: [20, 20] });
                }
                setGeometry(geometry);
                showDetailsStep();
            } catch (error) {
                console.error(error);
                alert('No fue posible leer el archivo GeoJSON.');
            }
        };

        reader.readAsText(file);
    });

    setTimeout(() => map.invalidateSize(), 250);

    if (geometryField.value) {
        try {
            const geometry = JSON.parse(geometryField.value);
            const layer = L.geoJSON(geometry);
            layer.eachLayer(function (l) {
                drawnItems.addLayer(l);
            });
            if (drawnItems.getLayers().length) {
                map.fitBounds(drawnItems.getBounds(), { padding: [20, 20] });
            }
            updateGeometryDisplay(geometry);
            showDetailsStep();
        } catch (error) {
            console.warn('La geometría guardada no se pudo mostrar', error);
        }
    }

    {% if form.errors %}
    showDetailsStep();
    {% endif %}
});
</script>
{% endblock %}
