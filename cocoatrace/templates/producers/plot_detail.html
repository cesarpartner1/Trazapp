{% extends 'dashboard/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="page-heading">
        <div>
            <p class="page-subtitle">Plot {{ plot.plot_code }}</p>
            <h1 class="page-title">{{ plot.name }}</h1>
            <p class="page-helper">Geolocated field boundary and agronomic stats for {{ producer.full_name }}.</p>
        </div>
        <a href="{% url 'producer_detail' producer.pk %}" class="btn btn-outline-secondary">Back to Producer</a>
    </div>

    <div class="overview-grid">
        <div class="card">
            <div class="card-header">Plot Summary</div>
            <div class="card-body">
                <dl class="data-grid">
                    <div>
                        <dt>Plot ID</dt>
                        <dd>{{ plot.plot_code }}</dd>
                    </div>
                    <div>
                        <dt>Area (ha)</dt>
                        <dd>{{ plot.area_hectares }}</dd>
                    </div>
                    <div>
                        <dt>Created</dt>
                        <dd>{{ plot.created_at|date:"M d, Y" }}</dd>
                    </div>
                </dl>
            </div>
        </div>
    </div>

    <div class="card-flow">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fa-solid fa-map me-2"></i>
                    Boundary Map
                </div>
                {% if not plot_geojson %}
                <span class="status-chip status-rejected">No geometry stored</span>
                {% endif %}
            </div>
            <div class="card-body">
                <div id="plot-map"
                     class="plot-map"
                     data-default-center="6.2518,-75.5636"></div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const container = document.getElementById('plot-map');
        const [defaultLat, defaultLng] = (container.dataset.defaultCenter || '6.2518,-75.5636')
            .split(',')
            .map((value) => parseFloat(value));

        const map = L.map(container).setView([defaultLat, defaultLng], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const geojsonData = {{ plot_geojson|safe|default:'null' }};

        if (geojsonData) {
            const layer = L.geoJSON(geojsonData, {
                style: {
                    color: '#2563eb',
                    weight: 2,
                    fillOpacity: 0.25
                }
            }).addTo(map);
            map.fitBounds(layer.getBounds(), { padding: [20, 20] });
        } else {
            const notice = L.control({ position: 'topright' });
            notice.onAdd = function () {
                const div = L.DomUtil.create('div', 'status-chip status-rejected');
                div.textContent = 'No polygon saved';
                return div;
            };
            notice.addTo(map);
        }

        setTimeout(() => map.invalidateSize(), 200);
    });
</script>
{% endblock %}
